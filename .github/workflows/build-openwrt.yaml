name: Build OpenWrt for GL-MT6000

permissions:
  contents: write
  actions: write

on:
  workflow_dispatch:
  push:
    branches:
      - main
  repository_dispatch:
    types: [remote_commit]
  schedule:
    - cron: "38 1 */3 * *"

env:
  REMOTE_REPOSITORY: pesa1234/openwrt
  CONFIG_FILE: mt6000.config
  GH_TOKEN: ${{ github.token }}

jobs:
  check_commits:
    name: Check for new commits
    runs-on: ubuntu-24.04
    outputs:
      remote_branch: ${{ steps.check_commits.outputs.remote_branch }}
      release_prefix: ${{ steps.check_commits.outputs.release_prefix }}
      new_commits: ${{ steps.check_commits.outputs.new_commits }}
      latest_commit_sha: ${{ steps.check_commits.outputs.latest_commit_sha }}
    steps:
      - name: Check for new commits in pesa1234 repo
        id: check_commits
        run: |
          remote_branch=$(git ls-remote https://github.com/${{ env.REMOTE_REPOSITORY }}.git "refs/heads/next-*" | sed -e 's|\(.*heads/\)||' | grep -viE 'test|beta' | sort -V | tail -n1)
          [ -n "$remote_branch" ] && latest_commit_sha=$(gh api "repos/${{ env.REMOTE_REPOSITORY }}/commits/${remote_branch}" --jq .sha)
          [ -z "$latest_commit_sha" ] && { echo "*** COULD NOT GET latest_commit_sha FROM remote_branch=$remote_branch ***" ; exit 1; }
          gh api "repos/${{ github.repository }}/releases/latest" --jq .body 2>/dev/null | grep -q "${latest_commit_sha}" && echo "new_commits=false" >> $GITHUB_OUTPUT || echo "new_commits=true" >> $GITHUB_OUTPUT
          echo "remote_branch=${remote_branch}"
          echo "release_prefix=${remote_branch%.rss*}"
          echo "latest_commit_sha=$latest_commit_sha"
          echo "remote_branch=${remote_branch}" >> $GITHUB_OUTPUT
          echo "release_prefix=${remote_branch%.rss*}" >> $GITHUB_OUTPUT
          echo "latest_commit_sha=$latest_commit_sha" >> $GITHUB_OUTPUT

  prepare-toolchain:
    name: Prepare toolchain and caches
    needs: check_commits
    runs-on: ubuntu-24.04
    outputs:
      dl-cache-key: ${{ steps.dl-cache.outputs.cache-hit }}
    steps:
      - name: Checkout remote repository (shallow)
        uses: actions/checkout@v6
        with:
          repository: ${{ env.REMOTE_REPOSITORY }}
          ref: ${{ needs.check_commits.outputs.remote_branch }}
          fetch-depth: 1

      - name: Checkout current repository (builder files)
        uses: actions/checkout@v6
        with:
          path: "builder_repo"
          fetch-depth: 1

      - name: Install dependencies and free disk
        run: |
          sudo apt remove -y '*cloud*' '*firefox*' '*chrome*' '*dotnet*' '*php*' || true
          sudo apt update -y && sudo apt upgrade -y || true
          sudo apt install -y build-essential clang flex bison g++ gawk gettext libncurses-dev libssl-dev python3-setuptools rsync swig unzip zlib1g-dev file wget llvm golang || true
          sudo apt autoremove -y && sudo apt clean -y || true
          # remove docs and manpages to save space
          sudo rm -rf /usr/share/doc/* /usr/share/man/* || true

      - name: Free workspace .git to save space
        run: |
          # Only remove if not needed later
          rm -rf "$GITHUB_WORKSPACE/.git" || true

      - name: Restore 'dl' cache
        id: dl-cache
        uses: actions/cache@v4
        with:
          path: dl
          key: ${{ runner.os }}-openwrt-dl-${{ hashFiles('feeds.conf', 'builder_repo/${{ env.CONFIG_FILE }}') }}
          restore-keys: |
            ${{ runner.os }}-openwrt-dl-

      - name: Setup configuration and custom files (prepare)
        run: |
          # delete unneeded folders and patch files with repository info
          rm -frv builder_repo/.git builder_repo/.github || true
          for file in $(grep -rl XXXXXX builder_repo/); do echo "Patching: $file"; sed -i 's|XXXXXX/YYYYYY|${{ github.repository }}|g' "$file" || exit 1; done || true
          patch -p1 < builder_repo/attendedsysupgrade-with-GitHub.patch || true
          mv -v builder_repo/files ./ || true
          chmod -v 755 files/usr/bin/upgrade_custom_openwrt files/www/cgi-bin/github_* || true
          mv -v builder_repo/${{ env.CONFIG_FILE }} .config || true
          rm -rfv builder_repo || true
          make defconfig || true

      - name: Build only toolchain to populate dl and staging_dir/toolchain
        run: |
          # Use single job to limit disk and temporary files
          make toolchain/install -j1 V=s || true

      - name: Cache toolchain (staging_dir/toolchain)
        uses: actions/cache@v4
        with:
          path: staging_dir/toolchain
          key: ${{ runner.os }}-openwrt-toolchain-${{ hashFiles('feeds.conf', '.config') }}
          restore-keys: |
            ${{ runner.os }}-openwrt-toolchain-

  build:
    name: Build OpenWrt
    needs: [check_commits, prepare-toolchain]
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'push' || needs.check_commits.outputs.new_commits == 'true'
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout remote repository (shallow)
        uses: actions/checkout@v6
        with:
          repository: ${{ env.REMOTE_REPOSITORY }}
          ref: ${{ needs.check_commits.outputs.remote_branch }}
          fetch-depth: 1

      - name: Checkout current repository (builder files)
        uses: actions/checkout@v6
        with:
          path: "builder_repo"
          fetch-depth: 1

      - name: Free disk space before build
        run: |
          sudo apt-get -y clean || true
          sudo rm -rf /var/lib/apt/lists/* /var/cache/apt/archives/* /usr/share/doc/* /usr/share/man/* || true
          df -h || true

      - name: Restore 'dl' cache
        uses: actions/cache@v4
        with:
          path: dl
          key: ${{ runner.os }}-openwrt-dl-${{ hashFiles('feeds.conf', 'builder_repo/${{ env.CONFIG_FILE }}') }}
          restore-keys: |
            ${{ runner.os }}-openwrt-dl-

      - name: Restore toolchain cache
        uses: actions/cache@v4
        with:
          path: staging_dir/toolchain
          key: ${{ runner.os }}-openwrt-toolchain-${{ hashFiles('feeds.conf', 'builder_repo/${{ env.CONFIG_FILE }}') }}
          restore-keys: |
            ${{ runner.os }}-openwrt-toolchain-

      - name: Setup configuration and custom files (final)
        run: |
          rm -frv builder_repo/.git builder_repo/.github || true
          for file in $(grep -rl XXXXXX builder_repo/); do echo "Patching: $file"; sed -i 's|XXXXXX/YYYYYY|${{ github.repository }}|g' "$file" || exit 1; done || true
          patch -p1 < builder_repo/attendedsysupgrade-with-GitHub.patch || true
          mv -v builder_repo/files ./ || true
          chmod -v 755 files/usr/bin/upgrade_custom_openwrt files/www/cgi-bin/github_* || true
          mv -v builder_repo/${{ env.CONFIG_FILE }} .config || true
          rm -rfv builder_repo || true
          make defconfig || true

      - name: Build firmware (limited parallelism)
        run: |
          # try parallel then fallback to -j1 if disk issues
          make download -j$(nproc) || {
            echo "Retrying download with -j1...";
            sleep 20;
            make download -j1 V=s;
          }
          # reduce parallelism to avoid creating excessive temporary files
          make -j1 V=s || {
            echo "Retrying build with -j1...";
            sleep 20;
            make -j1 V=s;
          }
          mkdir -p firmware
          find ./bin -type f \( -iname 'openwrt-*-sysupgrade.bin' -or -iname 'config.buildinfo' -or -iname 'version.buildinfo' \) -exec mv -v {} ./firmware/ \; ||:
          mv .config firmware/full.config ||:
          cd firmware && sha256sum openwrt-*-sysupgrade.bin >sha256sums ||:

      - name: Upload artifacts
        uses: actions/upload-artifact@v6.0.0
        with:
          name: gl-mt6000-firmware
          path: firmware/*

      - name: Create release
        run: |
          RELEASE_DATE=$(date +%F)
          gh release delete "${{ needs.check_commits.outputs.release_prefix }}-${RELEASE_DATE}" --cleanup-tag -y --repo "${{ github.repository }}" ||:
          gh release create "${{ needs.check_commits.outputs.release_prefix }}-${RELEASE_DATE}" --repo "${{ github.repository }}" --latest --notes "### ðŸ”„ Main Repository\n- **Repository:** [${{ env.REMOTE_REPOSITORY }}](https://github.com/${{ env.REMOTE_REPOSITORY }})\n- **Branch:** ${{ needs.check_commits.outputs.remote_branch }}\n- **Commit:** ${{ needs.check_commits.outputs.latest_commit_sha }}\n\n### ðŸ“ Build Information\n- **Target:** [Flint 2 (GL-MT6000)](https://openwrt.org/toh/gl.inet/gl-mt6000)\n- **Configuration:** [${{ env.CONFIG_FILE }}](${{ env.CONFIG_FILE }})\n- **WiFi UCODE scripts**\n- **Wireguard VPN**\n- **Policy Based Routing**\n- **Ad Block Fast\n- **REMOVED:** odhcp, upnp, iptables, avahi, samba, usb storage..." --title "OpenWrt Custom Release for Flint 2 (${{ needs.check_commits.outputs.release_prefix }}-${RELEASE_DATE})" firmware/* ||:

      - name: Clean up old releases
        run: |
          gh api repos/${{ github.repository }}/releases | jq -r '.[10:][] | "\(.id) \(.tag_name)"' | while read id tag; do
            gh api -X DELETE "repos/${{ github.repository }}/releases/$id" && gh api -X DELETE "repos/${{ github.repository }}/git/refs/tags/$tag" 2>/dev/null ||:
          done
